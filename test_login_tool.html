<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»åç³»çµ±æ•´åˆæ¸¬è©¦</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        img { display: block; margin: 10px 0; border: 1px solid #ddd; }
        button { padding: 10px 20px; cursor: pointer; }
        input { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .status-ok { color: green; font-weight: bold; }
        .status-err { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ ä¸­å¤®é»åç³»çµ± - æ•´åˆæ¸¬è©¦å·¥å…·</h2>

    <div class="box">
        <h3>1. å–å¾—é©—è­‰ç¢¼ (Verify)</h3>
        <button onclick="getCaptcha()">ğŸ”„ é‡æ–°æ•´ç†é©—è­‰ç¢¼</button>
        <div id="captcha-area" style="display:none; margin-top:15px;">
            <p>PicID: <strong id="picID-display"></strong></p>
            <img id="captcha-img" src="" alt="é©—è­‰ç¢¼åœ–ç‰‡" width="200">
        </div>
        <p id="verify-msg"></p>
    </div>

    <div class="box">
        <h3>2. ç™»å…¥æ¸¬è©¦ (Login)</h3>
        <input type="hidden" id="picID">
        <label>è¼¸å…¥ä¸Šæ–¹çœ‹åˆ°çš„é©—è­‰ç¢¼ï¼š</label>
        <input type="text" id="verifyCode" placeholder="ä¾‹å¦‚: 1234">
        <button onclick="doLogin()">ğŸš€ ç™»å…¥</button>
        <pre id="login-result">ç­‰å¾…æ“ä½œ...</pre>
    </div>

    <div class="box">
        <h3>3. æª¢æŸ¥é€£ç·šç‹€æ…‹ (Check Session)</h3>
        <button onclick="checkSession()">ğŸ” æª¢æŸ¥ç›®å‰ç‹€æ…‹</button>
        <pre id="session-result">ç­‰å¾…æ“ä½œ...</pre>
    </div>

    <script>
        // è¨­å®šæ‚¨çš„ API å…¥å£ä½ç½®
        const API_BASE = 'api.php'; 

        async function getCaptcha() {
            document.getElementById('verify-msg').innerText = "è¼‰å…¥ä¸­...";
            try {
                const res = await fetch(`${API_BASE}?path=central-verify`);
                const data = await res.json();
                
                if(data.status === 'success') {
                    document.getElementById('captcha-area').style.display = 'block';
                    document.getElementById('captcha-img').src = data.url; // é¡¯ç¤ºåœ–ç‰‡
                    document.getElementById('picID').value = data.picID;   // å¡«å…¥ hidden input
                    document.getElementById('picID-display').innerText = data.picID;
                    document.getElementById('verify-msg').innerHTML = '<span class="status-ok">âœ… å·²å–å¾—åœ–ç‰‡</span>';
                    document.getElementById('verifyCode').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                } else {
                    document.getElementById('verify-msg').innerHTML = '<span class="status-err">âŒ å¤±æ•—: ' + data.message + '</span>';
                }
            } catch (e) {
                document.getElementById('verify-msg').innerText = "âŒ è«‹æ±‚éŒ¯èª¤: " + e.message;
            }
        }

        async function doLogin() {
            const picID = document.getElementById('picID').value;
            const code = document.getElementById('verifyCode').value;
            const resultBox = document.getElementById('login-result');

            if(!picID || !code) {
                alert("è«‹å…ˆå–å¾—é©—è­‰ç¢¼ä¸¦è¼¸å…¥ä»£ç¢¼ï¼");
                return;
            }

            resultBox.innerText = "ç™»å…¥ä¸­...";
            
            try {
                const res = await fetch(`${API_BASE}?path=central-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ picID: picID, verifyCode: code })
                });
                const data = await res.json();
                resultBox.innerText = JSON.stringify(data, null, 2);
                
                if(data.success) {
                    checkSession(); // ç™»å…¥æˆåŠŸå¾Œé †ä¾¿æª¢æŸ¥ç‹€æ…‹
                }
            } catch (e) {
                resultBox.innerText = "âŒ è«‹æ±‚éŒ¯èª¤: " + e.message;
            }
        }

        async function checkSession() {
            const resultBox = document.getElementById('session-result');
            resultBox.innerText = "æª¢æŸ¥ä¸­...";
            try {
                const res = await fetch(`${API_BASE}?path=central-session`);
                const data = await res.json();
                resultBox.innerText = JSON.stringify(data, null, 2);
            } catch (e) {
                resultBox.innerText = "âŒ è«‹æ±‚éŒ¯èª¤: " + e.message;
            }
        }

        // é é¢è¼‰å…¥æ™‚å…ˆæŠ“ä¸€æ¬¡
        window.onload = getCaptcha;
    </script>
</body>
</html>